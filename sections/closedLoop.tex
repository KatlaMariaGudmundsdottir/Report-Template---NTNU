\begin{document}
\sectiontitle{10}{Closed-Loop FES Control}
\setstretch{1.6}
A closed-loop control system was implemented in order to improve the quality of the stimulated step while also minimizing fatigue. This was achieved by dynamically adjusting the current amplitude by using a  PI controller dynamically adjust the current amplitude so that only the required current to induce the desired movement was applied. The final closed-loop design takes into account the lack of a viable phase detection algorithm, as discussed previously. Instead, the system relies solely on knee angle feedback and uses a time-dependent reference knee angle.

\subsection{Methods}
\subsubsection{Closed-Loop Design}
The methodology for designing the closed-loop system for functional electrical stimulation (FES) began with an assessment of the available resources and constraints. The most significant limitation was the lack of a gait phase detection algorithm, which necessitated an alternative approach for managing state transitions. In addition, the available hardware included inertial measurement units (IMUs) for feedback, which could provide knee angle estimates but no direct phase detection capability.

Given these constraints, the system was designed to rely on open-loop transitions for changing stimulation states. This decision was informed by the controlled rehabilitation environment, where patients would walk at a consistent speed on a treadmill, enabling predictable and timed transitions without phase detection.

The next step involved determining how feedback from the IMUs could be incorporated. Knee angle data from the IMUs was selected as the primary variable for controlling the intensity of muscle stimulation. A linear controller was chosen for its simplicity and effectiveness in adjusting stimulation intensity based on real-time knee angle measurements.

Finally, the methodology focused on integrating these elements into an efficient and cohesive control system. This required defining the specific implementations of the key components, including the knee angle reference, gait cycle duration, proportional-integral (PI) controller, feedforward current, and current saturation mechanisms.

\subsubsection{Knee Angle Reference Design}
To use the knee angle error as an input for the PI controller, it is essential to establish a reliable and accurate reference. The kneeâ€™s range of motion during the gait cycle follows a characteristic pattern, which provides critical information about the natural movement of the leg. This curve represents the typical knee angle changes that occur during healthy gait and serves as a benchmark for evaluating deviations. A clear example of this pattern is shown in Figure \ref{fig:kneecurvetypical}.

\begin{figure} [h]
    \centering
    \includegraphics[width=0.99\linewidth]{images/B9780702043444000158_f015-005-9780702043444.jpg}
    \caption{Typical knee angle values during healthy gait \cite{themes_biomechanics_2017}}
    \label{fig:kneecurvetypical}
\end{figure}
It was decided that the knee angle reference would be based on this curve. Instead of implementing static knee angle references for certain phases of the gait cycle, the reference angle would change continuously over time following the reference curve. This decision was made to create smoother transitions and result in more consistent and gradual variations in the stimulation.

Two different approaches to creating the reference curve were attempted. The first involved simply re-creating the general shape and amplitude of the typical knee angle curve by combination of two sinus curves tuned by-hand. 

The second approach was based on extracting the curve by fitting a Fourier series to the measured knee angle data during gait. A Fourier series fitting is a mathematical technique used to represent a periodic function as a sum of sine and cosine terms, allowing for the decomposition of complex waveforms into simpler harmonic components \cite{blackledget_chapter_2006}. The data used for the fitting is from the open source data set of gait analysis measurements by Camargo et al. \cite{camargo_comprehensive_2021}. For that dataset several subjects were fitted with, among other things, a goniometer attached to the knee angle in order to get exact measurements of the knee angle during walking on a treadmill. 

For extracting the curve a single dataset at a single speed (approximately 1 m/s) was used. Then a Fourier series is used to approximate the periodic knee angle data. The series is expressed mathematically as:
\begin{equation}
f(x) = a_0 + \sum_{i=1}^{n} \left( a_i \cos(2\pi i x) + b_i \sin(2\pi i x) \right)
\end{equation}

\begin{itemize}
    \item \(a_0\) is the constant offset (mean value of the function).
    \item \(a_i\) and \(b_i\) are the Fourier coefficients for the cosine and sine terms, respectively.
    \item \(n\) is the number of harmonics, which determines the complexity of the approximation.
\end{itemize}

In order to extract coefficient that best fit the data \texttt{curve\_fit} function from \texttt{SciPy} is used. the number of harmonics (\textit{n}) is set to 3 in order to balance accuracy and computational efficiency. This number provides enough flexibility to capture the primary general shape of the motion without over fitting to noise or adding unnecessary complexity.

\subsubsection{Validation of the Closed-Lopp FES Control}
The closed loop implementation was tested on a single healthy subject at two different speeds while walking on the treadmill. The subject was instructed to try to put little weight on the leg that to be stimulated and try to relax the muscles as much as possible during the stimulation sequence. The subjects leg length was measured and gait cycle duration was set according to the methodology laid out in the methods section on gait cycle duration. After finding the correct electrode placements, the motor threshold and maximum tolerable intensity, the feedforward value was set to a value between those values and the proportional gain and integral gain were tuned. 

\subsection{Closed-Loop Design}
\begin{figure} [H]
    \centering
    \includegraphics[width=1.1\linewidth]{images/controldiam3.png}
    \caption{Closed-loop control diagram}
    \label{fig:cldiam}
\end{figure}
\newpage
\begin{wrapfigure}{r}{0.37\textwidth}
    \centering
    \includegraphics[width=\linewidth]{images/clsetupimg.jpg}
    \caption{IMU and electrode placement for closed loop FES}
    \label{fig:clsetupimg}
\end{wrapfigure}

A visualization of the closed loop control flow can be seen in figure \ref{cldiam}. The closed-loop takes in a knee angle reference that is fetched based on the current time and the gait cycle duration from the knee angle reference curve. Based on the the current time and gait cycle duration the current gait cycle percentage is extracted and used to determine which subphase of the gait the system should be in, based on this the muscles to stimulate are determined. The muscles that correlate to each subphase are based on the open-loop stimulation sequence, and can be seen in figure \todo{create figure for muscles}. Then for each muscle that should be stimulated a PI tuned for that specific muscle is run and there is a feedforward current that is summed with the PI current in order to get the current that will be sent to the StimWave board which then stimulates the muscles of the user. From the IMUs attached to the thigh and shank of the leg that should be stimulated the knee angle is then extracted and used as a feedback. A picture of the electrode and IMU placements on a single subject can be seen in figure \ref{fig:clsetupimg}.

The PI controller was chosen for its ability to address the system's specific needs.  Even though the reference angle changes over time a proportional-only controller may not adequately address persistent and steady-state errors as it only responds to the instantaneous error. Adding the integral term which accumulates error over time, effectively compensates for any consistent offset (e.g. under- or over-stimulation) that the proportional term cannot eliminate. 

\todo{Dicrete PI controller figure}

In a FES system, delays in muscle activation and mechnical response can cause the actual knee angle to lag behind the desired reference. By including an integral term the controller accounts for these delays indirectly: if the knee angle lags due to delayed muscle response, the accumulateed error promts the system to apply a sustained correction to minimize the offset over time.

The justification for not including a derivative term is that even though the derivative term would in theory enhance the responsiveness to rapid changes it would also simplify the noise in the system. The IMU measurements and subsequent knee angle calculation is noisy and including a derivative term could quickly destabilize the control loop.

\subsection{Knee Angle Reference Design}
\subsubsection{Simplified Curve}
The resulting curve modeled as the sum of two sinusoidal components, defined as:
\[
y(x) =
\begin{cases}
A_1 \sin\left(2 \pi f_1 x + \phi_1\right) + C_1, & 0 \leq x \leq 40 \\
A_2 \sin\left(2 \pi f_2 x + \phi_2\right) + C_2, & x > 40
\end{cases}
\]
where the parameters are defined as:

For the first bump:
\[
A_1 = 11, \quad f_1 = \frac{0.1}{4}, \quad \phi_1 = \frac{\pi}{2} + 2\pi f_1 \cdot 20, \quad C_1 = 15
\]

For the second bump:
\[
A_2 = 30, \quad f_2 = \frac{0.1}{6}, \quad \phi_2 = -\frac{\pi}{2} + 2\pi f_2 \cdot 80, \quad C_2 = 34
\]


A visualization of this curve can be seen in figure \ref{fig:simplecurve}. When comparing this however with the typical knee angle curve there are some major differences such as the height of the end of the second sinus curbe and height of the valley between the two curves. Because of these discrepancies another approach was attempted.
\begin{figure} [h]
    \centering
    \includegraphics[width=0.8\linewidth]{images/simpleKneeAngle.png}
    \caption{Simplified knee angle curve during gait, created by combining two sinusoids}
    \label{fig:simplecurve}
\end{figure}

\subsubsection{Fitted Curve}
The final, more complex, fitted curve is plotted alongside the original data in figure \ref{fig:kneeangleref} which demonstrates how well the Fourier series captures the periodic behavior of the knee angle during gait. This improved resemblance to a physiological knee angle curve and since there is only a small change in computational complexity online with this more complicated equation led to the fitted curve being chosen as the curve used for the closed-loop implementation.
\begin{figure} [h]
    \centering
    \includegraphics[width=0.99\linewidth]{images/goodkneeangleref.png}
    \caption{Fitted fourier series curve to experimental knee angle data from \cite{camargo_comprehensive_2021}}
    \label{fig:kneeangleref}
\end{figure}
\begin{figure} [h]
    \centering
    \includegraphics[width=0.85\linewidth]{images/fittedKneeAngleRef.png}
    \caption{Final reference curve, obtained by fitting a fourier series to experimental knee angle data}
    \label{fig:enter-label}
\end{figure}
\todo{fix figure}


\subsection{Implementation}
\subsubsection{Knee Angle Reference}
In order to use the fitted curve as the reference for the PI controller, the knee angle corresponding to the current percentage of the gait cycle must be extracted in real time. This process begins by determining which percentage of the gait cycle the system is currently in. This is calculated using the current time and the gait cycle duration set by the user. The corresponding knee angle is then retrieved from the fitted curve. Which is then fed to the PI controller.

\subsubsection{Gait Cycle Duration}
As mentioned the reference knee angle degree value depends on the gait cycle duration and current time, therefore setting the correct gait cycle duration for each user is an important step. Gait cycle duration defines the time required for one complete stride, encompassing the full sequence of movements from both legs. 

When running the FES experiments on a treadmill this gait cycle duration will vary from user to user and is therefore important to calculate before starting the stimulation. The primary input is the treadmill speed (\(v\)) in (m/s). The second essential parameter is the subjects leg length (\(L\)), measured as the distance from the greater trochanter to the floor in meters \cite{meinders_how_2021}. Then the Froude number (\(Fr)\) which is a widely used descriptor in gait analysis is:
\begin{equation}
    Fr = \frac{v^2}{g \cdot L}
\end{equation}
Where g is gravitational acceleration. Once the Froude number is calculated the stride frequency (\(f_s\)) can be estimated using the following relationship \cite{meinders_how_2021}:
\begin{equation}
    f_s = \sqrt{\frac{g \cdot Fr}{L}}
\end{equation}
From which the gait cycle duration is extracted and inserted into the program to ensure that the closed loop runs on a gait cycle duration that is comfortable for the user.

\subsubsection{PI controller}
To dynamically adjust the current amplitude based on the error between the desired and actual knee angle, a proportional-integral (PI) controller was implemented and tuned for each muscle independently. 

The PI controller was implemented in the \texttt{LoopController} class based on the following discrete time equation:
\begin{equation}
I_{PI}(t) = 
\begin{cases} 
-K_p \cdot e(t) - K_i \cdot \frac{\Delta t}{2} \left(e(t) + e(t-\Delta t)\right), & \text{if extension phase} \\
K_p \cdot e(t) + K_i \cdot \frac{\Delta t}{2} \left(e(t) + e(t-\Delta t)\right), & \text{otherwise}
\end{cases}
\end{equation}

Where \( e(t-\Delta t) \) is the error at the previous time step. As is clear from the formula the integral term is calculated using trapezoidal integration. By averaging the error values at the start and end of the interval the trapezoidal approavh better captures the varying nature of the error compared to rectangular integration which assumes that the error remains constant during the interval \(\delta t\). It also reduces the likelihood of abrupt changes to the PI output since it accounts for error trends between time steps rather than using just the current error.

The PI controller also incorporates a phase-specific adaptation. This is because in knee extension increasing the stimulation of the extensor muscles decresases the knee angle, while increased stimulation of flexion muscles will increase the knee angle. To prevent counterproductive stimulation the controller therefor inverts its output during extension.

\subsection{Feedforward Current}
A feedforward current is implemented for each muscle individually to provide a baseline stimulation amplitude, ensuring sufficient activation to induce movement. It is set around the midpoint between the motor threshold and the maximum tolerable intesity found for each muscle during setup. 

\begin{figure}
    \centering
    \includegraphics[width=0.65\linewidth]{images/clgui.png}
    \caption{Graphical User Interface for Closed Loop FES, including functionality to tune Kp, Ki, set initial feedforward stimulation and maximum intensity (mA)}
    \label{fig:clsetup}
\end{figure}

Including a feedforward current is particularly beneficial in FES systems because it provides a consisten baseline for muscle activation reducing reliance on reactibe feedback adjustments and ensuring smotther, more predictable responses during the giat cycle. It also helps address delays in muscle activation and mechenical response by esnuring timely stimulation even before feedback corrections take effect. Additionally, the feedforward current reduces the workload on the feeback controller by offloading the need for large corrective actions requiring large gain values, allowing the controller to focus on fine-tuning adjustments.

Finally the feedforward current contributes to minimizing muscle fatigue by ensuring that the stimulation is applied more evenly over time. This reduces the need for large corrective currents, which could otherwise lead to over-stimulation and discomfort.

\subsubsection{Current Saturation}
The final calculated current is the sum of the feedforward current and the PI computed current saturated for safety reasons. The maximum possible current amplitude is the maximum tolerable intensity found during the setup and is set for each muscle individually. This saturated current is sent to the StimWave which then applies the stimulation with the set current amplitude, frequency and pulse width to the electrodes for each active muscle.

\subsection{Results}
\subsubsection{Slower Speed}
During the slower speed stimulation the following parameters were tuned and used on the subject:

\begin{table}[h!]
\centering
\caption{Closed Loop Parameters for 0.8km/h}
\begin{tabular}{|l|c|c|c|c|c|}
\hline
\textbf{Muscle} & \textbf{Feedforward Current (mA)} & \textbf{Stimulation Limit (mA)} & \textbf{$K_p$} & \textbf{$K_i$} \\ \hline
Tibialis Anterior  & 35 & 45 & 0.1 & 0.05 \\ \hline
Vastus Medialis    & 25 & 35 & 0.3 & 0.05 \\ \hline
Gastrocnemius      & 35 & 45 & 0.1 & 0.05 \\ \hline
Hamstring          & 35 & 50 & 0.4 & 0.05 \\ \hline
\end{tabular}
\label{tab:closed_loop_9}
\end{table}

\begin{figure} [H]
    \centering
    \includegraphics[width=0.95\linewidth]{images/CL9refpng.png}
    \caption{Closed loop knee angles for 0.8km/h}
    \label{fig:cl9ref}
\end{figure}

\begin{figure} [H]
    \centering
    \includegraphics[width=0.9\linewidth]{images/CL9stimpng.png}
    \caption{Closed loop stimulation for 0.8km/h}
    \label{fig:cl9stim}
\end{figure}

Based on the reults seen in figure \ref{fig:cl9ref} and \ref{fig:cl9stim}, the closed loop control system demonstartes a resonable ability to follow the major peaks and valleys of the reference knee angle trajectory at the slower speed of 0.8 km/h. The measured knee angle aligns well with the timing and amplitude of the primary peaks. 

However, the system struggles to replicate the smaller peaks and subtler variations in the reference trajectory. This discrepancy could can be attributed to limitations in the PI controls responsiveness to small variations in reference knee angle and delay in muscle response. This issue might however be possible to mitigate by further tuning of the gains. As can be observed in figure \ref{fig:cl9stim} the variation in stimulation amplitude is not very large, indicating that there is room for increasing the gains and thus the variation in intensity.  

Notably, there is minimal delay observed between the initiation of the initial spike in the reference signal and the corresponding response in the measured knee angle. This highlights the control systems rapid reaction time, which is curcial for maintaining synchrnoization with the reference gait pattern.

\todo{talk more about the stimulation and compare with open loop stimulation}

\subsubsection{Faster Speed}
During the faster speed (1.5km/h) the following parameters were tuned and used on the subject:

\begin{table}[h!]
\centering
\caption{Closed Loop Parameters for 1.5km/h}
\begin{tabular}{|l|c|c|c|c|c|}
\hline
\textbf{Muscle}  & \textbf{Feedforward Current (mA)} & \textbf{Stimulation Limit (mA)} & \textbf{$K_p$} & \textbf{$K_i$} \\ \hline
Tibialis Anterior & 35 & 45 & 0.2 & 0.05 \\ \hline
Vastus Medialis   & 20 & 35 & 0.4 & 0.05 \\ \hline
Gastrocnemius     & 35 & 45 & 0.2 & 0.05 \\ \hline
Hamstring          & 35 & 50 & 0.5 & 0.05 \\ \hline
\end{tabular}
\label{tab:closed_loop_12}
\end{table}

\begin{figure} [H]
    \centering
    \includegraphics[width=0.9\linewidth]{images/CL12ref.png}
    \caption{Closed loop knee angles for 1.5km/h}
    \label{fig:cl12ref}
\end{figure}

\begin{figure} [H]
    \centering
    \includegraphics[width=0.9\linewidth]{images/CL12stim.png}
    \caption{Closed loop stimulation}
    \label{fig:cl12stim}
\end{figure}

\todo{Take a look at raw IMU data}
\todo{Take a look at Open loop, compare stim}

At a faster speed of 1.5km/h the results (figure \ref{fig:cl12ref} demonstrate that the closed-loop control system is capable of following the general trajectory of the referance knee angle values. However there is a marked delay between the reference curve and the measured curve, which was not present to the same degree at a slower speed.

Another interesting observation is that the systems seems to more accurately capture the smaller peaks in the trajectory compared to the slower speed. This is likely due to the increased gains in the control system leading to larger variations in the stimulation amplitude as can be seen in figure \ref{fig:cl12stim}.

Compared to the slower speed it is also clear the sampling frequency of the IMU measurements might be becoming an issue at this speed. This is particularly evident during periods of faster transitions, in which the measured signal becomes more jagged and noisy, possibly leading to suboptimal stimulation intensities being applied. 

\subsection{Discussion}
The results of the closed-loop gait control system provide an initial insight into the system's capabilities and limitations. The first issue is that of the difficulty of testing FES on healthy subjects, discussed earlier for the Open-Loop stimulation sequence.

The limited subject pool is another issue. Testing on a single subject restricts the generalizability of the results and does not account for individual variability. Differences in muscle composition, skin impedance and motor thresholds could significantly affect the control system's performance. A larger cohort of subjects would provide a more comprehensice understanding of the system's robustness.

Finally the delay and jagged IMU signal at faster speeds might indicate the limits of the system's control bandwidth at higher walking speeds. If the IMU signals do not manage to have a high enough accuracy to accurately measure the knee angle the closed loop control will introduce errors into the system that will make it in effect worse than the open loop implementation. The madgwick filter has been proved to introduce very minimal delays, so this might indivate that the IMU sampling frequency might be insufficient to capture rapid movements accurately. 

\subsection{Further Work}
Future studies would benefit from adding a weight support system to minimize voluntary recruitment when testing in healthy individuals. However testing in a in individuals with neurological impairments would clearly be the best case scenario. The limited subject pool should be addressed in future work.

In further iterations it would be interesting to use a reference curve that was averaged across multiple subjects in order to make it more generalizable. Possibly making curves based on demographic groups and speed groups such as female young adult or male middle aged, since there is some variation in gait dynamics between demographics, especially related to age and sex and weight.

\end{document}